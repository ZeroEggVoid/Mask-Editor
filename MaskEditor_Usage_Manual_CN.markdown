# 二值掩码图编辑器使用手册

## 概述

二值掩码图编辑器是一款基于 Python 和 Tkinter 的图像编辑工具，专为创建和编辑二值掩码图设计。支持多图层管理、图像导入与处理、自动掩码生成、播放动画等功能，适用于图像分割、掩码编辑等场景。程序兼容 Pyodide，可在浏览器中运行。

## 功能特点

- **多图层管理**：支持新建、删除、隐藏、排序和重命名图层。
- **图像处理**：支持导入图像（PNG、JPG、BMP 等），提供灰度化、二值化、彩色化选项，并支持裁剪或补白。
- **编辑工具**：提供画笔（自由绘制）、矩形画黑/擦除、区域选择/复制/粘贴/删除功能。
- **自动掩码**：基于灰度或 LAB 阈值生成掩码，或使用白色像素交集，应用到倒数第一个图层。
- **播放动画**：以指定间隔显示倒数第二个图层，逐层交换，适合预览多图层效果。
- **撤销/重做**：支持最多 50 次操作历史记录。
- **分辨率设置**：默认 VGA (640x480)，支持自定义分辨率。
- **界面交互**：支持鼠标滚轮缩放、中键拖动、网格模式、坐标轴显示、图层面板拖动。

## 安装与运行

1. **环境要求**：
   - Python 3.7+（或 Pyodide 环境）
   - 依赖库：`tkinter`、`PIL` (Pillow)、`numpy`、`opencv-python`、`datetime`、`platform`、`asyncio`

2. **运行程序**：
   - 下载 `mask_editor.py` 文件。
   - 在本地 Python 环境中运行：
     ```bash
     python mask_editor.py
     ```
   - 或在支持 Pyodide 的浏览器环境中加载（无需本地安装）。

3. **界面布局**：
   - **主画布**：左侧显示图像，支持编辑和预览。
   - **图层面板**：右侧显示图层列表，支持选择、隐藏、删除和重命名。
   - **菜单栏**：顶部包含“文件”、“编辑”、“工具”、“图层”、“设置”和“帮助”菜单。
   - **状态栏**：底部显示当前操作状态和提示。

## 操作指南

### 1. 文件操作

#### 生成白板
- **功能**：创建一个新的空白图层（白色，二值掩码）。
- **操作**：菜单栏 → 文件 → 生成白板
- **说明**：
  - 默认分辨率为 640x480（VGA）。
  - 如果已设置自定义分辨率（见“设置分辨率”），则使用自定义分辨率。
  - 新白板将替换所有现有图层，并成为当前图层。
- **示例**：点击“生成白板”，生成一个 640x480 的白色图层，命名为“Layer 1”。

#### 导入图片
- **功能**：导入图像文件，支持 PNG、JPG、BMP 等格式。
- **操作**：菜单栏 → 文件 → 导入图片
- **说明**：
  - 导入模式（通过“文件 → 导入处理”选择）：
    - **灰度化**：将图像转换为灰度（L 模式）。
    - **二值化**：根据设置的阈值（灰度或 LAB）将图像转换为二值掩码。
    - **彩色化**：保留图像为 RGB 模式。
  - 导入后进入裁剪预览窗口：
    - 若图像大于目标分辨率，拖动鼠标框选裁剪区域（放开鼠标确认）。
    - 若图像小于目标分辨率，可选择“居中并补白”或“放大到目标”。
  - 新图层命名为“Layer N”（N 为图层序号），添加到图层列表。
- **示例**：选择“彩色化”模式，导入一张 JPG 图像，裁剪后添加到新图层“Layer 2”。

#### 自动掩码
- **功能**：根据灰度或 LAB 阈值生成掩码，或使用白色像素交集，应用到倒数第一个图层。
- **操作**：菜单栏 → 文件 → 自动掩码
- **说明**：
  - 至少需要两个图层（底图层和至少一个前景图层）。
  - **灰度阈值**（若设置）：处理灰度图（L 模式），取阈值范围内的像素交集。
  - **LAB 阈值**（若设置）：处理彩色图（RGB 模式），取 LAB 空间阈值范围内的像素交集。
  - **白色像素交集**（若灰度和 LAB 阈值均未设置）：处理二值化图（L 模式），取白色像素（255）的交集。
  - 结果应用到倒数第一个图层（通常为底图层），将交集区域设为黑色（0）。
- **示例**：设置灰度阈值 `100,200`，点击“自动掩码”，倒数第一个图层更新为灰度图交集的掩码。

#### 掩码反转
- **功能**：反转当前图层的黑白像素（0 ↔ 255）。
- **操作**：菜单栏 → 文件 → 掩码反转
- **说明**：
  - 仅对当前选中的图层生效。
  - 若图层为 RGB 模式，先转换为灰度（L 模式）再反转。
- **示例**：选择“Layer 1”，点击“掩码反转”，黑色区域变为白色，白色区域变为黑色。

#### 保存掩码
- **功能**：保存所有可见图层的复合掩码（灰度模式）。
- **操作**：菜单栏 → 文件 → 保存掩码
- **说明**：
  - 弹出保存对话框，选择保存路径和文件名（默认扩展名 .png）。
  - 复合掩码为所有可见图层的叠加结果（白色背景，黑色前景）。
- **示例**：点击“保存掩码”，选择路径 `/path/to/mask.png`，保存复合掩码。

#### 快速保存
- **功能**：以时间戳命名快速保存复合掩码。
- **操作**：菜单栏 → 文件 → 快速保存
- **说明**：
  - 自动生成文件名 `mask_YYYYMMDD_HHMMSS.png`（如 `mask_20250810_191200.png`）。
  - 保存路径为程序运行目录。
- **示例**：点击“快速保存”，生成文件 `mask_20250810_191200.png`。

### 2. 编辑操作

#### 撤销/重做
- **功能**：撤销或重做最近的操作（最多 50 次历史记录）。
- **操作**：
  - 撤销：菜单栏 → 编辑 → 撤销（快捷键：`Ctrl+Z` 或 `Z`）
  - 重做：菜单栏 → 编辑 → 重做（快捷键：`Ctrl+Y` 或 `Y`）
- **说明**：支持撤销/重做的操作包括绘图、图层管理、移动区域等。
- **示例**：绘制矩形后按 `Ctrl+Z`，撤销绘制操作。

#### 选择区域
- **功能**：选择当前图层的指定区域，用于复制、粘贴或删除。
- **操作**：菜单栏 → 编辑 → 选择区域
- **说明**：
  - 选择“选择”工具后，点击图像自动选择非白色区域，或拖动鼠标框选自定义区域。
  - 蓝色矩形框显示选定区域。
- **示例**：选择“Layer 1”，点击“选择区域”，拖动鼠标框选 (100,100,200,200)。

#### 复制/粘贴/删除区域
- **功能**：复制、粘贴或删除选定区域。
- **操作**：
  - 复制：菜单栏 → 编辑 → 复制
  - 粘贴：菜单栏 → 编辑 → 粘贴
  - 删除：菜单栏 → 编辑 → 删除选定区域
- **说明**：
  - **复制**：复制当前图层的选定区域到剪贴板。
  - **粘贴**：将剪贴板内容粘贴到当前图层左上角 (0,0)。
  - **删除**：将选定区域填充为白色（255 或 RGB (255,255,255)）。
- **示例**：选择区域 (100,100,200,200)，点击“复制”，切换到“Layer 2”，点击“粘贴”，区域粘贴到 (0,0)。

### 3. 工具

#### 画黑（矩形）
- **功能**：在当前图层绘制黑色矩形。
- **操作**：菜单栏 → 工具 → 画黑（矩形）
- **说明**：
  - 拖动鼠标绘制矩形，松开确认。
  - 在网格模式下，矩形边界按合并因子（默认 1）对齐。
  - RGB 图层绘制黑色 (0,0,0)，灰度图绘制黑色 (0)。
- **示例**：选择“画黑（矩形）”，在“Layer 1”上拖动绘制黑色矩形 (50,50,150,150)。

#### 擦除（矩形）
- **功能**：在当前图层擦除（填充为白色）。
- **操作**：菜单栏 → 工具 → 擦除（矩形）
- **说明**：
  - 拖动鼠标擦除矩形区域，松开确认。
  - RGB 图层填充白色 (255,255,255)，灰度图填充白色 (255)。
- **示例**：选择“擦除（矩形）”，在“Layer 1”上拖动擦除区域 (50,50,150,150)。

#### 画笔（自由）
- **功能**：在当前图层自由绘制（黑色）或擦除（白色）。
- **操作**：菜单栏 → 工具 → 画笔（自由）
- **说明**：
  - 按住左键拖动绘制圆形画笔轨迹。
  - 画笔大小可通过“设置 → 设置画笔大小”调整（默认 5 像素）。
  - 绘制黑色或擦除白色，RGB 图层分别使用 (0,0,0) 或 (255,255,255)。
- **示例**：选择“画笔（自由）”，设置画笔大小为 10，在“Layer 1”上绘制自由路径。

### 4. 图层管理

#### 新建图层
- **功能**：创建新的空白图层（白色）。
- **操作**：菜单栏 → 图层 → 新建图层
- **说明**：
  - 新图层命名为“Layer N”（N 为图层序号），分辨率为当前目标分辨率。
  - 新图层成为当前图层并显示在图层列表中。
- **示例**：点击“新建图层”，创建“Layer 2”，分辨率为 640x480。

#### 排序图层
- **功能**：调整图层显示顺序。
- **操作**：菜单栏 → 图层 → 排序图层
- **说明**：
  - 打开排序窗口，左侧显示已排序图层，右侧显示未排序图层。
  - 双击右侧图层添加到排序列表，点击左侧图层移除。
  - 点击“应用排列”保存新顺序。
- **示例**：将“Layer 2”移到排序列表顶部，点击“应用排列”，更新图层顺序。

#### 选择图层
- **功能**：选择当前编辑的图层。
- **操作**：在右侧图层列表中单击图层名称。
- **说明**：选中的图层高亮显示，状态栏更新为“已选择图层：{名称}”。
- **示例**：点击“Layer 1”，状态栏显示“已选择图层：Layer 1”。

#### 隐藏/显示图层
- **功能**：切换图层可见性（透明度 0.3 表示隐藏，1.0 表示显示）。
- **操作**：在图层列表中选择图层，点击“隐藏”按钮。
- **说明**：
  - 隐藏前景白板（灰度图）时，若背景图层为彩色（RGB），则以原始彩色显示。
  - 隐藏状态在图层列表中显示为“(已隐藏)”。
- **示例**：选择“Layer 1”（白板），点击“隐藏”，背景“Layer 2”（RGB）显示为彩色。

#### 删除图层
- **功能**：删除选中的图层。
- **操作**：在图层列表中选择图层，点击“删除”按钮。
- **说明**：
  - 不能删除最后一个图层。
  - 删除后自动选择剩余图层中的最后一个。
- **示例**：选择“Layer 2”，点击“删除”，图层列表更新。

#### 重命名图层
- **功能**：修改图层名称。
- **操作**：在图层列表中右键图层，选择“重命名”。
- **说明**：
  - 弹出窗口输入新名称，名称不能为空且不能与现有图层名称重复。
  - 更新排序列表中的名称（如果已排序）。
- **示例**：右键“Layer 1”，选择“重命名”，输入“Background”，确认后图层名称更新。

### 5. 设置

#### 设置分辨率
- **功能**：设置目标分辨率，影响新白板和导入图像。
- **操作**：菜单栏 → 设置 → 设置分辨率
- **说明**：
  - 输入格式：`宽×高`（如 `800×600`）。
  - 分辨率必须为正整数。
  - 现有图层将调整大小到新分辨率（使用 LANCZOS 插值）。
  - 自定义分辨率优先于默认 640x480。
- **示例**：输入 `800×600`，点击“应用”，所有图层调整为 800x600。

#### 设置画笔大小
- **功能**：调整自由画笔的直径。
- **操作**：菜单栏 → 设置 → 设置画笔大小
- **说明**：
  - 输入正整数（单位：像素，默认 5）。
  - 影响“画笔（自由）”工具的绘制效果。
- **示例**：输入 `10`，点击“应用”，画笔大小设为 10 像素。

#### 设置像素合并因子
- **功能**：设置网格模式下像素对齐的合并因子。
- **操作**：菜单栏 → 设置 → 设置像素合并因子
- **说明**：
  - 输入正整数（默认 1，表示无合并）。
  - 影响矩形绘制和画笔的对齐精度。
- **示例**：输入 `4`，点击“应用”，绘制操作按 4x4 像素网格对齐。

#### 设置阈值
- **功能**：设置导入图像二值化时的阈值。
- **操作**：菜单栏 → 设置 → 设置阈值
- **说明**：
  - **灰度阈值**：格式 `min,max`（如 `100,200`），范围 [0,255]，min ≤ max。
  - **LAB 阈值**：格式 `Lmin,Lmax,Amin,Amax,Bmin,Bmax`（如 `0,200,100,150,100,150`），L ∈ [0,255]，A/B ∈ [-128,127]，min ≤ max。
  - 影响“二值化”模式下的图像导入。
- **示例**：输入 LAB 阈值 `0,200,100,150,100,150`，点击“应用”，导入二值化图像时使用该阈值。

#### 设置自动掩码阈值
- **功能**：设置自动掩码的阈值。
- **操作**：菜单栏 → 设置 → 设置自动掩码阈值
- **说明**：
  - **灰度阈值**：格式 `min,max`（如 `100,200`），留空则不处理灰度图。
  - **LAB 阈值**：格式 `Lmin,Lmax,Amin,Amax,Bmin,Bmax`（如 `0,200,100,150,100,150`），留空则不处理彩色图。
  - 若两者均为空，仅处理二值化图的白色像素交集。
  - 阈值验证同“设置阈值”。
- **示例**：输入灰度阈值 `100,200`，LAB 阈值留空，点击“应用”，自动掩码仅处理灰度图。

#### 设置播放间隔
- **功能**：设置播放动画的间隔时间。
- **操作**：菜单栏 → 设置 → 设置播放间隔
- **说明**：
  - 输入正数（单位：秒，默认 3）。
  - 影响播放动画中图层切换的间隔。
- **示例**：输入 `2`，点击“应用”，播放间隔设为 2 秒。

#### 设置预览画面
- **功能**：启用/禁用图像预览。
- **操作**：菜单栏 → 设置 → 设置预览画面（勾选/取消勾选）
- **说明**：禁用预览时，画布显示占位符文本。
- **示例**：取消勾选“设置预览画面”，画布显示“无图像，请导入或生成白板”。

### 6. 视图

#### 显示像素网格
- **功能**：在画布上显示像素网格。
- **操作**：菜单栏 → 视图 → 显示像素网格（勾选/取消勾选）
- **说明**：
  - 网格按合并因子（默认 1）绘制，缩放比例足够大时可见。
  - 影响矩形绘制和画笔的对齐。
- **示例**：勾选“显示像素网格”，设置合并因子为 4，画布显示 4x4 像素网格。

#### 显示图层栏
- **功能**：显示/隐藏右侧图层面板。
- **操作**：菜单栏 → 视图 → 显示图层栏（勾选/取消勾选）
- **说明**：隐藏后可通过拖动重新显示。
- **示例**：取消勾选“显示图层栏”，图层面板隐藏。

#### 显示坐标轴
- **功能**：在画布上显示坐标轴。
- **操作**：菜单栏 → 视图 → 显示坐标轴（勾选/取消勾选）
- **说明**：
  - 坐标轴每 10 像素标注，50 像素显示大刻度。
  - 便于精确编辑。
- **示例**：勾选“显示坐标轴”，画布显示 X/Y 轴刻度。

### 7. 播放动画

- **功能**：以指定间隔播放图层动画。
- **操作**：在图层列表中点击“播放”按钮（播放后变为“停止”）。
- **说明**：
  - 至少需要三个图层。
  - 动画流程：
    1. 显示倒数第二个图层（其他图层隐藏）。
    2. 等待间隔后，从倒数第三个图层开始，逐层与倒数第二个图层交换并显示。
    3. 最后将第一个图层与倒数第二个图层交换。
    4. 播放结束后恢复原始图层顺序。
  - 间隔通过“设置 → 设置播放间隔”调整（默认 3 秒）。
- **示例**：有图层“Layer 1”、“Layer 2”、“Layer 3”，点击“播放”，显示“Layer 2”，每 3 秒切换显示其他图层。

### 8. 交互操作

#### 缩放
- **功能**：缩放画布显示。
- **操作**：鼠标滚轮向上（放大）或向下（缩小）。
- **说明**：
  - 缩放范围：0.1x 至 10x。
  - 以鼠标位置为中心缩放。
- **示例**：在画布中心滚轮向上，缩放比例增加到 2.0。

#### 平移
- **功能**：拖动画布移动显示区域。
- **操作**：按住鼠标中键拖动。
- **说明**：平移不影响图像内容，仅调整显示位置。
- **示例**：中键拖动画布，将图像向左移动 100 像素。

#### 拖动图层面板
- **功能**：调整图层面板位置。
- **操作**：点击图层面板顶部并拖动。
- **说明**：便于自定义界面布局。
- **示例**：拖动图层面板到窗口右上角。

## 注意事项

- **图层限制**：至少保留一个图层，无法删除最后一个图层。
- **分辨率调整**：更改分辨率会调整所有图层大小，可能影响图像质量。
- **自动掩码**：确保至少有两个图层，且底图层有图像，否则无法执行。
- **播放动画**：需要三个以上图层，播放期间其他操作可能被限制。
- **保存路径**：快速保存使用程序运行目录，建议检查磁盘空间。
- **Pyodide 兼容**：避免本地文件 I/O 和网络调用，确保浏览器环境支持。

## 示例工作流程

1. **创建白板**：
   - 菜单栏 → 设置 → 设置分辨率，输入 `800×600`。
   - 菜单栏 → 文件 → 生成白板，创建 800x600 白板（Layer 1）。

2. **导入彩色图像**：
   - 菜单栏 → 文件 → 导入处理 → 彩色化。
   - 菜单栏 → 文件 → 导入图片，选择 `image.jpg`，裁剪为 800x600，添加为 Layer 2。

3. **设置自动掩码阈值**：
   - 菜单栏 → 设置 → 设置自动掩码阈值，输入灰度阈值 `100,200`，LAB 阈值 `0,200,100,150,100,150`。
   - 菜单栏 → 文件 → 自动掩码，生成掩码并应用到 Layer 1。

4. **编辑掩码**：
   - 选择 Layer 1，点击“工具 → 画笔（自由）”，设置画笔大小为 10，绘制黑色区域。
   - 选择“工具 → 擦除（矩形）”，擦除部分区域。

5. **隐藏白板显示彩色**：
   - 在图层列表中选择 Layer 1，点击“隐藏”，Layer 2 的彩色图像显示。

6. **重命名图层**：
   - 右键 Layer 1，选择“重命名”，输入“Mask”，确认。

7. **播放动画**：
   - 添加 Layer 3（新白板），点击“播放”，查看图层切换动画。

8. **保存结果**：
   - 菜单栏 → 文件 → 快速保存，生成 `mask_20250810_191200.png`。

## 常见问题

- **Q：导入图像后显示不正确？**
  - A：检查导入模式（灰度化/二值化/彩色化）和阈值设置，确保图像格式支持（PNG/JPG/BMP）。
- **Q：自动掩码没有效果？**
  - A：确保至少有两个图层，且前景图层为灰度或彩色，阈值设置合理。
- **Q：播放动画卡顿？**
  - A：尝试缩短播放间隔或减少图层数量，检查浏览器性能。
- **Q：如何恢复默认设置？**
  - A：菜单栏 → 编辑 → 重置，清空所有图层和设置，恢复默认状态。

## 更新日志

- **2025年8月10日**：
  - LAB 阈值输入顺序变更为 `Lmin,Lmax,Amin,Amax,Bmin,Bmax`。
  - 优化自动掩码逻辑：灰度/LAB 阈值为空时跳过对应处理，均空时处理白色像素交集。
  - 支持隐藏前景白板显示背景彩色图像。
  - 图层列表右键支持重命名。
  - 自动掩码阈值窗口采用上下布局。
  - 默认分辨率为 VGA (640x480)，支持自定义分辨率。
